<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de env√≠o de visa links | Distelsa</title>
    <style>
        :root { --primary: #0056b3; --dark: #002d5e; --bg: #f4f7f6; --success: #28a745; --danger: #d9534f; --warning: #ffc107; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        
        /* LOGIN ORIGINAL STYLE */
        #loginPage { background: linear-gradient(135deg, var(--dark) 0%, var(--primary) 100%); height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        
        /* APP STYLE */
        #appPage { display: none; }
        header { background: var(--dark); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1000px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .seccion-dinamica { background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .equipo-item { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center; background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-enviar { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; width: 420px; padding: 25px; border-radius: 8px; }
        
        /* TABLAS */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { background: #f0f0f0; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="login-box">
        <div style="font-size: 28px; font-weight: 800; color: var(--primary);">Grupo Distelsa</div>
        <p style="color: #666; margin-bottom: 30px;">Gesti√≥n de Env√≠o de Visa Links</p>
        <form id="formLogin">
            <input type="text" id="user" placeholder="Usuario" required style="margin-bottom:15px">
            <input type="password" id="pass" placeholder="Contrase√±a" required style="margin-bottom:20px">
            <button type="submit" id="btnLog" class="btn-enviar">INGRESAR</button>
        </form>
        <div id="msgLogin" style="color:red; margin-top:15px; display:none"></div>
    </div>
</div>

<div id="appPage">
    <header>
        <div><strong>Grupo Distelsa</strong> | <span id="txtPerfil">Perfil</span></div>
        <div>Agente: <span id="txtAgente">...</span> <button onclick="cerrarSesion()" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; margin-left:10px">Salir</button></div>
    </header>

    <div class="container">
        <h2>Registrar Nueva Gesti√≥n</h2>
        <form id="formGestion">
            <div class="grid-2">
                <div><label>Tipo de Servicio:</label>
                    <select id="tipoServicio" onchange="cambiarTipoServicio()">
                        <option value="visita">Diagn√≥stico / Visita (Q175)</option>
                        <option value="otros">Otros Servicios (Monto Manual)</option>
                    </select>
                </div>
                <div><label>M√©todo de Pago:</label>
                    <select id="metodoPago" onchange="toggleMetodoPago()">
                        <option value="visa">Visa Link</option>
                        <option value="deposito">Dep√≥sito / Transferencia</option>
                    </select>
                </div>
            </div>

            <div class="seccion-dinamica">
                <h4>1. Datos de Contacto y Facturaci√≥n</h4>
                <div class="grid-2">
                    <input type="text" id="cNombre" placeholder="Nombre contacto" required>
                    <input type="text" id="cTel" placeholder="Tel√©fono" required>
                    <input type="text" id="fNit" placeholder="NIT o CF" required>
                    <input type="text" id="fNom" placeholder="Nombre Factura" required>
                    <input type="email" id="fMail" placeholder="Correo electr√≥nico" style="grid-column: span 2" required>
                    <input type="text" id="cDir" placeholder="Direcci√≥n exacta" style="grid-column: span 2" required>
                </div>
            </div>

            <div id="seccionVisita" class="seccion-dinamica">
                <label>Equipos a Revisar (Q175 c/u):</label>
                <div id="listaEquipos">
                    <div class="equipo-item">
                        <input type="text" placeholder="Marca" class="eq-marca" required>
                        <input type="text" placeholder="Modelo" class="eq-modelo" required>
                        <input type="text" placeholder="Falla" class="eq-falla" required>
                        <button type="button" style="background:none; color:red; border:none; cursor:pointer" disabled>X</button>
                    </div>
                </div>
                <button type="button" onclick="agregarEquipo()" style="background:var(--success); color:white; border:none; padding:5px; margin-top:5px; border-radius:4px">+ Agregar Equipo</button>
            </div>

            <div id="seccionMontoManual" class="seccion-dinamica" style="display:none">
                <input type="text" id="conceptoManual" placeholder="Concepto del cobro">
                <input type="number" id="montoManual" placeholder="Monto Q" oninput="actualizarTotal()" style="margin-top:10px">
            </div>

            <input type="url" id="vLink" placeholder="Enlace de Visa Link" style="margin-bottom:20px">
            
            <div style="font-size: 24px; font-weight: bold; text-align: right; margin-bottom: 20px;">Total: Q <span id="lblTotal">175.00</span></div>
            <button type="submit" id="btnEnviar" class="btn-enviar">ENVIAR A PENDIENTES</button>
        </form>
    </div>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 15px;">
            <div style="display: flex; gap: 20px;">
                <h3 id="tabP" style="cursor:pointer; color:var(--primary); border-bottom: 3px solid var(--primary)" onclick="switchTab('P')">‚è≥ Pendientes</h3>
                <h3 id="tabH" style="cursor:pointer; color:#777" onclick="switchTab('H')">üìÅ Historial</h3>
            </div>
            <input type="text" id="txtBuscar" placeholder="Buscar por NIT, Nombre, ID..." onkeyup="filtrarTabla()" style="width:250px">
        </div>

        <div id="vistaP">
            <table id="tablaPendientes">
                <thead><tr><th>Contacto</th><th>Detalle</th><th>Monto</th><th>Acci√≥n</th></tr></thead>
                <tbody></tbody>
            </table>
            <div id="paginacion" style="text-align:center; margin-top:10px; font-size:12px"></div>
        </div>
        <div id="vistaH" style="display:none">
            <table id="tablaHistorial">
                <thead><tr><th>Cliente</th><th>Monto</th><th>Estado</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API = 'https://script.google.com/macros/s/AKfycbw7dXYAATQpNABTVP7uZZc39XGdh0I_jJMg-YEHmGMxlgyZRtSaNphvWAugyB8cdhEwJA/exec'; // <--- PEGA TU URL DE IMPLEMENTACI√ìN
    let DATA_LOCAL = [];

    // L√ìGICA DE LOGIN PERSISTENTE [cite: 2026-02-09]
    window.onload = () => { if(localStorage.getItem('distelsa_token')) mostrarApp(); };

    document.getElementById('formLogin').onsubmit = async (e) => {
        e.preventDefault();
        const res = await fetch(API, {
            method: 'POST',
            body: JSON.stringify({ usuario: document.getElementById('user').value, password: document.getElementById('pass').value })
        });
        const r = await res.json();
        if(r.status === 'success') {
            localStorage.setItem('distelsa_user', r.data.usuario);
            localStorage.setItem('distelsa_nombre', r.data.nombre);
            localStorage.setItem('distelsa_rol', r.data.rol);
            localStorage.setItem('distelsa_perfil', r.data.perfil);
            localStorage.setItem('distelsa_token', r.data.token);
            mostrarApp();
        } else {
            document.getElementById('msgLogin').innerText = r.data;
            document.getElementById('msgLogin').style.display = 'block';
        }
    };

    function mostrarApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('appPage').style.display = 'block';
        document.getElementById('txtAgente').innerText = localStorage.getItem('distelsa_nombre');
        document.getElementById('txtPerfil').innerText = localStorage.getItem('distelsa_perfil');
        cargarBandeja();
    }

    async function cargarBandeja() {
        const url = `${API}?accion=getData&perfil=${localStorage.getItem('distelsa_perfil')}&rol=${localStorage.getItem('distelsa_rol')}`;
        const res = await fetch(url);
        const r = await res.json();
        DATA_LOCAL = r.data.pendientes;
        renderTabla(DATA_LOCAL);
        renderHistorial(r.data.historial);
    }

    // PAGINACI√ìN DE LOS PRIMEROS 10 [cite: 2026-02-09]
    function renderTabla(lista) {
        const body = document.querySelector('#tablaPendientes tbody');
        const slice = lista.slice(0, 10);
        body.innerHTML = slice.map(i => `
            <tr>
                <td><strong>${i.contactoNombre}</strong><br><small>Tel: ${i.telefono}</small></td>
                <td><small>NIT: ${i.nit}<br>${i.detalle}</small></td>
                <td>Q${i.monto}</td>
                <td><button onclick="confirmar('${i.id}')" style="background:var(--success); color:white; border:none; padding:5px; border-radius:4px; cursor:pointer">Pagar</button></td>
            </tr>
        `).join('');
        document.getElementById('paginacion').innerText = `Mostrando ${slice.length} de ${lista.length} pendientes.`;
    }

    // B√öSQUEDA EN 6 COLUMNAS [cite: 2026-02-16]
    function filtrarTabla() {
        const q = document.getElementById('txtBuscar').value.toLowerCase();
        const filtrados = DATA_LOCAL.filter(i => 
            i.contactoNombre.toLowerCase().includes(q) || i.nit.toLowerCase().includes(q) || 
            i.id.toLowerCase().includes(q) || i.detalle.toLowerCase().includes(q) || 
            i.telefono.toLowerCase().includes(q) || i.agente.toLowerCase().includes(q)
        );
        renderTabla(filtrados);
    }

    function agregarEquipo() {
        const div = document.createElement('div');
        div.className = 'equipo-item';
        div.innerHTML = `<input type="text" class="eq-marca" required><input type="text" class="eq-modelo" required><input type="text" class="eq-falla" required><button type="button" onclick="this.parentElement.remove();actualizarTotal()" style="color:red;border:none;background:none;cursor:pointer">X</button>`;
        document.getElementById('listaEquipos').appendChild(div);
        actualizarTotal();
    }

    function actualizarTotal() {
        const tipo = document.getElementById('tipoServicio').value;
        let total = tipo === 'visita' ? document.querySelectorAll('.equipo-item').length * 175 : document.getElementById('montoManual').value || 0;
        document.getElementById('lblTotal').innerText = parseFloat(total).toFixed(2);
    }

    function cambiarTipoServicio() {
        const t = document.getElementById('tipoServicio').value;
        document.getElementById('seccionVisita').style.display = t === 'visita' ? 'block' : 'none';
        document.getElementById('seccionMontoManual').style.display = t === 'visita' ? 'none' : 'block';
        actualizarTotal();
    }

    function cerrarSesion() { localStorage.clear(); location.reload(); }
    function switchTab(t) {
        document.getElementById('vistaP').style.display = t === 'P' ? 'block' : 'none';
        document.getElementById('vistaH').style.display = t === 'H' ? 'block' : 'none';
        document.getElementById('tabP').style.color = t === 'P' ? 'var(--primary)' : '#777';
        document.getElementById('tabH').style.color = t === 'H' ? 'var(--primary)' : '#777';
        document.getElementById('tabP').style.borderBottom = t === 'P' ? '3px solid var(--primary)' : 'none';
        document.getElementById('tabH').style.borderBottom = t === 'H' ? '3px solid var(--primary)' : 'none';
    }
</script>
</body>
</html>
