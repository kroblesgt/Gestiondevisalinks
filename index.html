<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Distelsa | Gesti√≥n de env√≠o de visa links</title>
    <style>
        :root { 
            --primary: #0056b3; --bg: #f4f7f6; --danger: #d9534f; 
            --success: #28a745; --dark: #002d5e; --warning: #ffc107; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* --- ESTILOS LOGIN --- */
        #loginPage {
            background: linear-gradient(135deg, var(--dark) 0%, var(--primary) 100%);
            height: 100vh; display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4); width: 100%; max-width: 350px; text-align: center;
        }
        .logo { font-size: 28px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .tagline { color: #666; font-size: 14px; margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        #msg { color: var(--danger); font-size: 13px; margin-top: 15px; display: none; background: #fdf2f2; padding: 8px; border-radius: 4px; }

        /* --- ESTILOS AGENTE --- */
        #agentePage { display: none; padding-bottom: 40px; }
        header { background: var(--dark); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1000px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .seccion-dinamica { background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .equipo-item { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center; background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* Tablas y Modales */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { background: #f0f0f0; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 420px; padding: 25px; border-radius: 8px; }

        /* Elementos Comunes */
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; border-radius: 6px; border: none; }
        .btn-enviar { background: var(--primary); color: white; padding: 12px; width: 100%; }
        .logout-btn { background: var(--danger); color: white; padding: 8px 15px; }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="login-box">
        <div class="logo">Grupo Distelsa</div>
        <div class="tagline">Gesti√≥n de Env√≠o de Visa Links</div>
        <form id="formLogin">
            <input type="text" id="user" placeholder="Usuario" required style="margin-bottom:15px">
            <input type="password" id="pass" placeholder="Contrase√±a" required style="margin-bottom:15px">
            <button type="submit" id="btnLog" class="btn-enviar">INGRESAR</button>
        </form>
        <div id="msg"></div>
    </div>
</div>

<div id="agentePage">
    <header>
        <div style="font-size: 18px;"><strong>Grupo Distelsa</strong> | Gesti√≥n de env√≠o de visa links</div>
        <div>Agente: <span id="nombreAgente">...</span> <button class="logout-btn" onclick="cerrarSesion()">Salir</button></div>
    </header>

    <div class="container">
        <h2 style="color:var(--primary)">Registrar Nueva Gesti√≥n</h2>
        <form id="formGestion">
            <div class="grid-2">
                <div><label>Tipo de Servicio:</label>
                    <select id="tipoServicio" onchange="cambiarTipoServicio()">
                        <option value="visita">Diagn√≥stico / Visita (Q175)</option>
                        <option value="instalacion">Instalaci√≥n</option>
                        <option value="mantenimiento">Mantenimiento</option>
                        <option value="filtros">Venta de Filtros</option>
                        <option value="presupuesto">Presupuesto / Repuestos</option>
                    </select>
                </div>
                <div><label>M√©todo de Pago:</label>
                    <select id="metodoPago" onchange="toggleMetodoPago()">
                        <option value="visa">Visa Link</option>
                        <option value="deposito">Dep√≥sito / Transferencia</option>
                    </select>
                </div>
            </div>

            <div class="seccion-dinamica">
                <h4 style="margin-top:0">1. Datos de Contacto (Visita)</h4>
                <div class="grid-2">
                    <input type="text" id="contactoNombre" placeholder="Nombre de quien recibe" required>
                    <input type="text" id="contactoTelefono" placeholder="Tel√©fono" required>
                    <input type="text" id="contactoDireccion" placeholder="Direcci√≥n exacta" style="grid-column: span 2" required>
                </div>
            </div>

            <div class="seccion-dinamica">
                <h4 style="margin-top:0">2. Datos de Facturaci√≥n</h4>
                <div class="grid-2">
                    <input type="text" id="facturacionNit" placeholder="NIT (o CF)" required>
                    <input type="text" id="facturacionNombre" placeholder="Nombre o Raz√≥n Social" required>
                    <input type="email" id="facturacionCorreo" placeholder="Correo para factura" style="grid-column: span 2" required>
                </div>
            </div>

            <div id="seccionVisita" class="seccion-dinamica">
                <label>Equipos a Revisar:</label>
                <div id="listaEquipos">
                    <div class="equipo-item">
                        <input type="text" placeholder="Marca" class="eq-marca" required>
                        <input type="text" placeholder="Modelo" class="eq-modelo" required>
                        <input type="text" placeholder="Falla" class="eq-falla" required>
                        <button type="button" class="btn-del" disabled>X</button>
                    </div>
                </div>
                <button type="button" onclick="agregarEquipo()" style="background:var(--success); color:white; padding:5px 10px; margin-top:10px">+ Agregar</button>
            </div>

            <div id="seccionOrden" class="seccion-dinamica" style="display:none">
                <input type="text" id="conceptoOrden" placeholder="Concepto del cobro" style="margin-bottom:10px">
                <input type="number" id="montoLibre" oninput="actualizarTotalVisual()" placeholder="Monto Q">
            </div>

            <div id="campoVisa"><input type="url" id="visaLink" placeholder="Enlace de Visa Link"></div>
            
            <div style="font-size: 24px; font-weight: bold; text-align: right; margin: 20px 0;">Total: Q <span id="montoVisual">175.00</span></div>
            <button type="submit" id="btnEnviar" class="btn-enviar">ENVIAR A PENDIENTES</button>
        </form>
    </div>

    <div class="container" style="border-top: 5px solid var(--primary)">
        <div style="display: flex; gap: 20px; border-bottom: 2px solid #eee; margin-bottom: 15px;">
            <h3 id="tabPendientes" style="cursor:pointer; color:var(--primary)" onclick="cambiarTab('pendientes')">‚è≥ Pendientes</h3>
            <h3 id="tabHistorial" style="cursor:pointer; color:#777" onclick="cambiarTab('historial')">üìÅ Historial</h3>
        </div>
        <div id="vistaPendientes">
            <table id="tablaPendientes"><thead><tr><th>Contacto</th><th>Detalle/Factura</th><th>Monto</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
        </div>
        <div id="vistaHistorial" style="display:none">
            <table id="tablaHistorial"><thead><tr><th>Cliente</th><th>Detalle</th><th>Estado</th><th>Cita</th></tr></thead><tbody></tbody></table>
        </div>
    </div>
</div>

<div id="modalConfirmar" class="modal">
    <div class="modal-content">
        <h3>Confirmar Pago</h3>
        <div style="background:#fff3cd; padding:10px; font-size:12px; margin-bottom:15px">
            <strong>Facturar a:</strong> <span id="modalNit"></span> | <span id="modalNombreFactura"></span>
        </div>
        <input type="hidden" id="modalIdGestionPago">
        <input type="text" id="modalOrdenFinal" placeholder="No. Orden de Servicio" style="margin-bottom:10px">
        <input type="date" id="modalFechaFinal" style="margin-bottom:15px">
        <label style="font-size:12px; color:red"><input type="checkbox" id="checkFactura"> Ya solicit√© la factura con los datos arriba mostrados.</label>
        <button onclick="procesarConfirmacion()" class="btn-enviar" style="background:var(--success); margin-top:15px">GUARDAR</button>
        <button onclick="cerrarModales()" style="width:100%; background:none; color:gray; margin-top:10px">Cancelar</button>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwJ_HUgwt_yTFuXaoEFB6eOue-AH58XJq9ClxYyMyTzrYvUgv9mhWTv2XZYJqzPmwY12g/exec';
    
    // --- L√ìGICA DE SESI√ìN ---
    window.onload = () => {
        const user = localStorage.getItem('distelsa_user');
        const token = localStorage.getItem('distelsa_token');
        if (user && token) {
            mostrarPanel();
        }
    };

    function mostrarPanel() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('agentePage').style.display = 'block';
        document.getElementById('nombreAgente').innerText = localStorage.getItem('distelsa_user');
        cargarDatos(localStorage.getItem('distelsa_user'));
    }

    document.getElementById('formLogin').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnLog');
        btn.disabled = true;
        btn.innerText = 'Verificando...';

        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    usuario: document.getElementById('user').value, 
                    password: document.getElementById('pass').value 
                }) 
            });
            const result = await res.json();
            if (result.status === 'success') {
                localStorage.setItem('distelsa_user', result.data.usuario);
                localStorage.setItem('distelsa_token', result.data.token);
                mostrarPanel();
            } else {
                document.getElementById('msg').innerText = result.message;
                document.getElementById('msg').style.display = 'block';
            }
        } catch (e) { alert('Error de conexi√≥n'); }
        btn.disabled = false; btn.innerText = 'INGRESAR';
    });

    function cerrarSesion() {
        localStorage.clear();
        location.reload();
    }

    // --- L√ìGICA OPERATIVA (AGENTE) ---
    function cambiarTipoServicio() {
        const t = document.getElementById('tipoServicio').value;
        document.getElementById('seccionVisita').style.display = t === 'visita' ? 'block' : 'none';
        document.getElementById('seccionOrden').style.display = t === 'visita' ? 'none' : 'block';
        actualizarTotalVisual();
    }

    function toggleMetodoPago() {
        document.getElementById('campoVisa').style.display = document.getElementById('metodoPago').value === 'visa' ? 'block' : 'none';
    }

    function agregarEquipo() {
        const div = document.createElement('div');
        div.className = 'equipo-item';
        div.innerHTML = `<input type="text" class="eq-marca" required><input type="text" class="eq-modelo" required><input type="text" class="eq-falla" required><button type="button" onclick="this.parentElement.remove();actualizarTotalVisual()">X</button>`;
        document.getElementById('listaEquipos').appendChild(div);
        actualizarTotalVisual();
    }

    function actualizarTotalVisual() {
        const t = document.getElementById('tipoServicio').value;
        const total = t === 'visita' ? document.querySelectorAll('.equipo-item').length * 175 : document.getElementById('montoLibre').value || 0;
        document.getElementById('montoVisual').innerText = parseFloat(total).toFixed(2);
    }

    document.getElementById('formGestion').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnEnviar');
        btn.disabled = true;

        const payload = {
            accion: 'nuevoEnvio',
            agente: localStorage.getItem('distelsa_user'),
            tipoServicio: document.getElementById('tipoServicio').value,
            metodoPago: document.getElementById('metodoPago').value,
            contactoNombre: document.getElementById('contactoNombre').value,
            contactoTelefono: document.getElementById('contactoTelefono').value,
            contactoDireccion: document.getElementById('contactoDireccion').value,
            facturacionNit: document.getElementById('facturacionNit').value,
            facturacionNombre: document.getElementById('facturacionNombre').value,
            facturacionCorreo: document.getElementById('facturacionCorreo').value,
            link: document.getElementById('visaLink').value || 'Dep√≥sito',
            montoTotal: document.getElementById('montoVisual').innerText
        };

        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert('Registro guardado');
            document.getElementById('formGestion').reset();
            cargarDatos(localStorage.getItem('distelsa_user'));
        } catch (e) { alert('Error al guardar'); }
        btn.disabled = false;
    });

    async function cargarDatos(user) {
        const res = await fetch(`${API_URL}?accion=getDataAgente&agente=${user}`);
        const data = await res.json();
        const bodyP = document.querySelector('#tablaPendientes tbody');
        bodyP.innerHTML = data.pendientes.map(item => `
            <tr>
                <td>${item.contactoNombre}</td>
                <td><small>Fac: ${item.nit}<br>${item.detalle}</small></td>
                <td>Q${item.monto}</td>
                <td><button onclick="abrirModalPago('${item.id}', '${item.nit}', '${item.nombreFacturacion}')">Confirmar</button></td>
            </tr>
        `).join('');
    }

    function abrirModalPago(id, nit, nombre) {
        document.getElementById('modalIdGestionPago').value = id;
        document.getElementById('modalNit').innerText = nit;
        document.getElementById('modalNombreFactura').innerText = nombre;
        document.getElementById('modalConfirmar').style.display = 'flex';
    }

    function cerrarModales() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
</script>
</body>
</html>
