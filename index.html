<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de envío de visa links</title>
    <style>
        :root { --primary: #0056b3; --dark: #002d5e; --bg: #f4f7f6; --success: #28a745; --danger: #d9534f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        
        /* LOGIN */
        #loginPage { background: var(--dark); height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; }
        
        /* PANEL PRINCIPAL */
        #mainPage { display: none; }
        header { background: var(--dark); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1100px; margin: 20px auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .hidden { display: none !important; }
        
        /* TABLAS Y BUSCADOR */
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { background: #eee; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .badge { padding: 4px 8px; border-radius: 12px; color: white; font-size: 10px; }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="login-box">
        <h2 style="color:var(--primary)">Grupo Distelsa</h2>
        <p>Gestion de Cobros Call Center</p>
        <form id="formLogin">
            <input type="text" id="user" placeholder="Usuario" required style="margin-bottom:10px">
            <input type="password" id="pass" placeholder="Contraseña" required style="margin-bottom:20px">
            <button type="submit" id="btnLog" class="btn-main">INGRESAR</button>
        </form>
    </div>
</div>

<div id="mainPage">
    <header>
        <div><strong>DISTELSA</strong> | <span id="txtPerfil">Perfil</span></div>
        <div>
            <span id="txtNombre">Usuario</span>
            <button id="btnAdmin" class="hidden" onclick="toggleAdminPanel()" style="background:#ffc107; margin:0 10px; padding:5px; border-radius:4px; border:none; cursor:pointer;">⚙️ Perfiles</button>
            <button onclick="cerrarSesion()" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Salir</button>
        </div>
    </header>

    <div id="adminPanel" class="container hidden" style="border: 2px solid #ffc107;">
        <h3>Gestión de Perfiles y Usuarios</h3>
        <div class="grid">
            <div>
                <h4>Crear Perfil (Célula)</h4>
                <input type="text" id="newPerfil" placeholder="Nombre (Ej: WhatsApp)">
                <button onclick="crearPerfil()" class="btn-main" style="margin-top:10px; background:var(--success)">Crear Célula</button>
            </div>
            <div>
                <h4>Asignar Perfil a Usuario</h4>
                <select id="selUser"></select>
                <select id="selPerfil" style="margin:10px 0;"></select>
                <button onclick="asignar()" class="btn-main">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div>
                <h3>Nuevo Envío de Link</h3>
                <form id="formEnvio">
                    <input type="text" id="cNombre" placeholder="Nombre del Cliente" required style="margin-bottom:10px">
                    <div style="display:flex; gap:10px; margin-bottom:10px">
                        <input type="text" id="fNit" placeholder="NIT" required>
                        <input type="text" id="fNom" placeholder="Nombre Factura" required>
                    </div>
                    <input type="url" id="vLink" placeholder="Enlace de Visa Link" required style="margin-bottom:10px">
                    <input type="number" id="vMonto" placeholder="Monto Q" required style="margin-bottom:10px">
                    <button type="submit" class="btn-main">REGISTRAR PENDIENTE</button>
                </form>
            </div>

            <div>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h3>Bandeja de Pendientes</h3>
                    <input type="text" id="txtBusqueda" placeholder="Buscar en 6 columnas..." onkeyup="buscar()" style="width:200px">
                </div>
                <div id="divTabla">
                    <table id="tablaEnvios">
                        <thead><tr><th>Cliente</th><th>Monto</th><th>Acción</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div id="paginacion" style="margin-top:10px; font-size:12px; text-align:center"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = 'https://script.google.com/macros/s/AKfycbxm3rnTSRRQ9iVeDajp7sd9DcM3XMmhrJpRA9aJE-JBDm2B-iG3e19Nv1zhYIknM-Eo8w/exec'; // <--- CAMBIA ESTO
    let LOCAL_DATA = [];

    // Persistencia de sesión [cite: 2026-02-09]
    window.onload = () => {
        if(localStorage.getItem('distelsa_token')) iniciarApp();
    };

    document.getElementById('formLogin').onsubmit = async (e) => {
        e.preventDefault();
        const res = await fetch(API, {
            method: 'POST',
            body: JSON.stringify({
                usuario: document.getElementById('user').value,
                password: document.getElementById('pass').value
            })
        });
        const r = await res.json();
        if(r.status === 'success') {
            localStorage.setItem('distelsa_user', r.data.usuario);
            localStorage.setItem('distelsa_rol', r.data.rol);
            localStorage.setItem('distelsa_perfil', r.data.perfil);
            localStorage.setItem('distelsa_nombre', r.data.nombre);
            localStorage.setItem('distelsa_token', r.data.token);
            iniciarApp();
        } else { alert(r.data); }
    };

    function iniciarApp() {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainPage').style.display = 'block';
        document.getElementById('txtNombre').innerText = localStorage.getItem('distelsa_nombre');
        document.getElementById('txtPerfil').innerText = localStorage.getItem('distelsa_perfil');
        
        // Habilitar panel de gestión según rol [cite: 2026-02-16]
        const rol = localStorage.getItem('distelsa_rol');
        if(rol === 'Admin' || rol === 'Lider') {
            document.getElementById('btnAdmin').classList.remove('hidden');
        }
        cargarDatos();
    }

    async function cargarDatos() {
        const url = `${API}?accion=getData&perfil=${localStorage.getItem('distelsa_perfil')}&rol=${localStorage.getItem('distelsa_rol')}`;
        const res = await fetch(url);
        const r = await res.json();
        LOCAL_DATA = r.data.pendientes;
        renderizarTabla(LOCAL_DATA);
    }

    // Paginación de 10 resultados [cite: 2026-02-09]
    function renderizarTabla(datos) {
        const tbody = document.querySelector('#tablaEnvios tbody');
        const slice = datos.slice(0, 10);
        tbody.innerHTML = slice.map(i => `
            <tr>
                <td><strong>${i.contacto}</strong><br><small>NIT: ${i.nit}</small></td>
                <td>Q${i.monto}</td>
                <td><button onclick="confirmar('${i.id}')" style="background:var(--success); color:white; border:none; padding:5px; border-radius:4px; cursor:pointer">Pagar</button></td>
            </tr>
        `).join('');
        document.getElementById('paginacion').innerText = `Mostrando ${slice.length} de ${datos.length} resultados.`;
    }

    // Búsqueda en 6 columnas [cite: 2026-02-16]
    function buscar() {
        const q = document.getElementById('txtBusqueda').value.toLowerCase();
        const filtrados = LOCAL_DATA.filter(i => 
            i.id.toLowerCase().includes(q) || 
            i.contacto.toLowerCase().includes(q) || 
            i.nit.toLowerCase().includes(q) || 
            i.nombreFac.toLowerCase().includes(q) ||
            i.agente.toLowerCase().includes(q) ||
            i.estado.toLowerCase().includes(q)
        );
        renderizarTabla(filtrados);
    }

    function toggleAdminPanel() {
        document.getElementById('adminPanel').classList.toggle('hidden');
    }

    function cerrarSesion() {
        localStorage.clear();
        location.reload();
    }
</script>
</body>
</html>
